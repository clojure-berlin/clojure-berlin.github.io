name: Expire past events

on:
  schedule:
    - cron: '0 6 * * *' # daily at 06:00 UTC

permissions:
  contents: write

jobs:
  expire:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for newly past events
        id: check
        run: |
          changed=false
          now=$(date +%s)

          for f in content/events/*.md; do
            [ "$f" = "content/events/_index.md" ] && continue
            grep -q '^status = "upcoming"' "$f" || continue

            event_end=$(grep -m1 '^event_end' "$f" | tr -d ' ' | cut -d= -f2)
            [ -z "$event_end" ] && continue

            if [ "$(date -d "$event_end" +%s)" -lt "$now" ]; then
              sed -i 's/^status = "upcoming"/status = "past"/' "$f"
              echo "Expired: $f"
              changed=true
            fi
          done
          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Commit and push
        if: steps.check.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add content/events/
          git commit -m "Expire past events"
          git push
